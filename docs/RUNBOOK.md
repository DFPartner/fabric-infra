# Runbook

This guide provides step-by-step instructions for common operational tasks.

## Table of Contents
1.  [Updates and New Versions](#updates-and-new-versions)
2.  [Restarts](#restarts)
3.  [Log Investigations](#log-investigations)
4.  [Connecting to Frontends/Dashboards](#connecting-to-frontendsdashboards)
5.  [Secrets Handling](#secrets-handling)
6.  [Helm Charts Debugging](#helm-charts-debugging)
7.  [Troubleshooting](#troubleshooting)

---

## Updates and New Versions

### Updating a Component Configuration
To update a configuration (e.g., changing a resource limit or an environment variable):
1.  Navigate to the component's directory in `platform/` (e.g., `platform/data/postgres`).
2.  Edit the `values.yaml` file.
3.  Commit and push the changes to the Git repository.
    ```bash
    git add platform/data/postgres/values.yaml
    git commit -m "chore(postgres): increase memory limit"
    git push origin main
    ```
4.  Argo CD will automatically detect the change and sync (usually within 3 minutes). You can verify this in the Argo CD UI or via CLI.

### Upgrading a Helm Chart Version
To upgrade the underlying software (e.g., new version of Redis):
1.  Edit `platform/data/redis/Chart.yaml` (if using a local chart) or the `Chart.yaml` dependencies (if using an upstream chart).
2.  Update the `appVersion` or the dependency `version`.
3.  Commit and push.

### Adding a New Application
1.  Create the implementation in `platform/<category>/<app-name>`.
2.  Create an Argo CD Application manifest in `clusters/<cluster>/applications/<app-name>.yaml`.
    -   You can copy an existing file from `clusters/bp-dsk/applications/` and adjust the `name`, `path` (pointing to your new platform folder), and `namespace`.
3.  Commit and push. The `root-app` for that cluster will detect the new file and create the new application.

---

## Restarts

Sometimes a pod gets stuck or needs a restart to pick up a config map change that doesn't trigger a rollout automatically.

**Restart all pods in a deployment:**
```bash
kubectl rollout restart deployment <deployment-name> -n <namespace>
```

**Example:**
```bash
kubectl rollout restart deployment prom-stack-grafana -n monitoring
```

---

## Log Investigations

### Using CLI (kubectl)
To view logs for a specific pod:
```bash
# List pods to get the name
kubectl get pods -n monitoring

# Tail logs
kubectl logs -f <pod-name> -n monitoring
```

### Using k9s (Recommended)
`k9s` is installed by the bootstrap script. It provides an interactive UI in the terminal.
1.  Run `k9s`.
2.  Type `:ns` to switch namespaces (select `monitoring` or `data`).
3.  Use arrow keys to select a pod.
4.  Press `l` to view logs.
5.  Press `Esc` to go back.

---

## Connecting to Frontends/Dashboards

Most internal services are not exposed publicly for security. You access them using **Port Forwarding**.

### Grafana
```bash
kubectl port-forward -n monitoring svc/prom-stack-grafana 3000:80
```
Access at: `http://localhost:3000`

### Argo CD UI
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```
Access at: `https://localhost:8080`

### Generic Port Forwarding
Find the service name and port:
```bash
kubectl get svc -n <namespace>
```
Forward the port:
```bash
kubectl port-forward -n <namespace> svc/<service-name> <local-port>:<service-port>
```

---

## Secrets Handling

Secrets are managed using **Bitnami Sealed Secrets**.
This allows us to check in encrypted secrets into the Git repository, which are then decrypted by the controller running in the cluster.

### Prerequisites
You need the `kubeseal` CLI tool installed. The bootstrap script `00-bootstrap/00-install-base.sh` installs the controller in the cluster.

### Creating a New Secret
1.  **Generate the Kubernetes Secret locally (dry-run):**
    ```bash
    kubectl create secret generic my-secret \
      --from-literal=password=supersecret \
      --namespace my-namespace \
      --dry-run=client -o yaml > my-secret.yaml
    ```
2.  **Seal the Secret:**
    ```bash
    kubeseal --controller-name=sealed-secrets-controller \
             --controller-namespace=auth \
             --format=yaml < my-secret.yaml > sealed-my-secret.yaml
    ```
3.  **Commit the Sealed Secret:**
    You can now safely commit `sealed-my-secret.yaml` to the repository (usually in the `platform/` directory alongside other resources).

### Rotating Secrets
Refer to `00-bootstrap/03-secrets.sh` for examples of how existing secrets were generated.

### Retrieving the Grafana Password
The initial password for Grafana is generated by the Helm chart.
```bash
kubectl get secret --namespace monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
```

---

## Helm Charts Debugging

If an application fails to sync or deploy, you might need to debug the Helm template generation.

### Render Templates Locally
To see exactly what YAML is being generated from your Helm chart + Values:
1.  Navigate to the component directory.
2.  Run `helm template`:
    ```bash
    cd platform/monitoring/alloy
    helm template . -f values.yaml
    ```
    This prints the final Kubernetes manifests to stdout. You can inspect this for syntax errors or incorrect values.

### Check Argo CD Status
If the sync fails, check the detailed error message in Argo CD:
```bash
kubectl get application <app-name> -n argocd -o yaml
```
Look at the `status.conditions` or `status.operationState` fields.

---

## Troubleshooting

### Kustomize Build Error: "Helm chart processing is not enabled"
If you see an error indicating that Kustomize does not enable Helm chart processing, it is because this feature is disabled by default for security.

**The Fix:** Update Argo CD Configuration.
You need to edit the `argocd-cm` ConfigMap in your cluster to enable this feature.

```bash
kubectl patch cm argocd-cm -n argocd --type merge -p '{"data":{"kustomize.buildOptions":"--enable-helm --load-restrictor LoadRestrictionsNone"}}'
```

**Restart the Repo Server:**
Argo CD caches build settings. To force it to pick up the change immediately, restart the repo server:
```bash
kubectl rollout restart deploy argocd-repo-server -n argocd
```

**Hard Refresh the App:**
Go to the Argo CD UI, navigate to the application, and click "Hard Refresh" (or in the "Refresh" dropdown).
